name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-skill:
    runs-on: ubuntu-latest
    name: Validate SKILL.md

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate SKILL.md
      run: |
        echo "Validating SKILL.md..."
        if [ ! -f "SKILL.md" ]; then
          echo "::error::SKILL.md not found!"
          exit 1
        fi

        # Check for required fields
        if ! grep -q "^name:" SKILL.md; then
          echo "::error::SKILL.md missing 'name' field"
          exit 1
        fi

        if ! grep -q "^description:" SKILL.md; then
          echo "::error::SKILL.md missing 'description' field"
          exit 1
        fi

        echo "✅ SKILL.md validation passed!"

  check-documentation:
    runs-on: ubuntu-latest
    name: Check Documentation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check required files
      run: |
        echo "Checking required documentation files..."
        required_files=("README.md" "LICENSE" "SKILL.md" ".gitignore")

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "::error::Required file $file not found!"
            exit 1
          fi
          echo "✅ $file exists"
        done

        echo "✅ All required files present!"

  lint-markdown:
    runs-on: ubuntu-latest
    name: Lint Markdown

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Lint Markdown files
      run: |
        echo "Linting Markdown files..."
        # Basic markdown linting
        find . -name "*.md" -type f | while read file; do
          # Check for trailing whitespace
          if grep -q " $" "$file"; then
            echo "::warning::$file has trailing whitespace"
          fi

          # Check for multiple consecutive blank lines
          if grep -P -n "^\n\n\n+" "$file"; then
            echo "::warning::$file has multiple consecutive blank lines"
          fi
        done

        echo "✅ Markdown linting completed!"

  test-skill-syntax:
    runs-on: ubuntu-latest
    name: Test SKILL Syntax

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test SKILL.md YAML frontmatter
      run: |
        echo "Testing SKILL.md YAML frontmatter..."

        # Extract YAML frontmatter
        awk '/^---$/{flag=!flag; next} flag' SKILL.md > /tmp/skill_yaml.yaml

        # Check if YAML is valid (basic check)
        if [ ! -s /tmp/skill_yaml.yaml ]; then
          echo "::error::SKILL.md YAML frontmatter is empty or invalid"
          exit 1
        fi

        echo "✅ SKILL.md YAML frontmatter is valid!"

  build-info:
    runs-on: ubuntu-latest
    name: Build Information
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate build info
      run: |
        echo "## Build Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
